# Copilot Instructions — Markdown Threads Extension

## Project Overview

VS Code extension enabling inline threaded comments on markdown files stored in Git. Comments persist as sidecar JSON files (`.comments.json`) alongside markdown docs, with one-click PR creation to GitHub or Azure DevOps.

All extension source lives under `src/`. The design spec is at `.designs/markdown-threads.design.md`.

## Architecture & Data Flow

**Preview-only architecture** — all comment interaction happens in a WebView sidebar. There is no VS Code Comments API (editor gutter) integration.

```
Markdown Doc (.md)
  → AnchorEngine (parse sections, compute slugs/hashes)
  → PreviewPanel (WebView sidebar — sole comment UI)
  → SidecarManager (read/write .comments.json, EventEmitter hub)
  → GitService + Providers (branch, commit, push, create PR)
```

### Key Components (all singletons — never instantiate a second copy)

| Singleton export | File | Role |
|---|---|---|
| `sidecarManager` | `sidecarManager.ts` | Read/write `.comments.json`, atomic writes, change event bus |
| `anchorEngine` | `anchorEngine.ts` | Parse markdown → `MarkdownSection[]`, cache per-doc, build `CommentAnchor` |
| `PreviewPanel` | `previewPanel.ts` | WebView rendering markdown + comment sidebar with reactions & stats chart (singleton via static `instance`) |
| `gitService` | `gitService.ts` | `simple-git` wrapper for branch/commit/push; detects provider from remote URL |
| `gitHubProvider` | `providers/githubProvider.ts` | PR creation via `@octokit/rest` |
| `adoProvider` | `providers/adoProvider.ts` | PR creation via `azure-devops-node-api` |
| `authManager` | `auth/authManager.ts` | `vscode.authentication.getSession` for GitHub (`'github'`) and Azure DevOps (`'microsoft'` with `499b84ac-.../.default` scope) |

## WriteOrigin Pattern (Critical)

Every `writeSidecar()` call **must** pass a `WriteOrigin` (`'preview'` | `'internal'`). After a successful write, `SidecarManager` fires `onDidChange({ docPath, origin })`. The preview panel **skips reloads when `origin === 'preview'`** to avoid echo loops.

```typescript
sidecarManager.onDidChange((e) => {
  if (e.origin === 'preview') return; // skip own writes
  this.update();
});
```

**When adding a new mutation path**, always tag it with the correct origin. Search for `writeSidecar(` to see all existing call sites.

## Resolved Thread Locking

When a thread is resolved, the preview WebView hides Reply input, Edit/Delete links, and Delete Thread button based on `thread.status`. The preview checks `status === 'resolved'` before allowing any mutation. Author-gating: edit/delete compare `comment.author` against `gitService.getUserName()`.

## Comment Reactions

`CommentEntry.reactions` is an optional `string[]` of author names. Use `sidecarManager.toggleReaction()` to add/remove — never mutate the array directly.

## Anchoring System

Comments anchor to markdown sections using a **three-part hybrid**:
1. `sectionSlug` — primary key, generated by `slugify()` in `utils/hash.ts`
2. `contentHash` — SHA-256 of first 200 chars of section body (truncated to 16 hex chars)
3. `lineHint` — line number, used only as a fast-path hint

Stale detection: slug matches but hash differs → `'stale'`. Slug missing → orphaned (still displayed as stale). Both match → current. See `AnchorEngine.detectStaleThreads()`.

## Type System

All domain types are in `src/models/types.ts`: `SidecarFile`, `CommentThread`, `CommentEntry`, `CommentAnchor`, `MarkdownSection`, `ProviderInfo`, `PRResult`. Import these with `import type` (TypeScript `strict` mode is on).

## Build & Dev Workflow

```sh
npm install
npm run compile        # tsc -p ./
npm run watch          # tsc --watch
npm run lint           # eslint src --ext ts
npm run test           # compiles first, then runs via @vscode/test-electron
npm run package        # vsce package → produces .vsix
```

Debug: press **F5** in VS Code to launch Extension Development Host. The extension activates on `onLanguage:markdown`.

## Testing Conventions

**Every change must include comprehensive tests. Run `npm run test` and confirm exit 0 after every change.**

- **Mocha** with Node `assert` — not Jest, no `expect()` syntax
- Test files: `src/test/suite/*.test.ts` (auto-discovered by glob)
- Mocha UI is `tdd` — use `suite()` / `test()`, not `describe()` / `it()`
- Test runner: `src/test/runTest.ts` using `@vscode/test-electron`

### What to Test

- **Pure utility functions** — see `hash.test.ts`: deterministic output, edge cases, truncation
- **Markdown parsing** — see `markdown.test.ts`: section extraction, slug generation, stale detection, code fences
- **SidecarManager operations** — see `sidecarManager.test.ts`: CRUD, round-trip I/O, `WriteOrigin` propagation. Use temp dirs for file I/O.
- **New mutations** — test resolved threads reject changes, author-gating blocks non-authors

```typescript
import * as assert from 'assert';
suite('Feature Test Suite', () => {
  test('describes specific behaviour', () => {
    assert.strictEqual(actual, expected);
  });
});
```

Avoid mocking VS Code APIs — keep unit tests on pure logic in `utils/`, `models/`, `sidecarManager`. VS Code integration is validated via F5 manual testing.

## Conventions

- **Singleton pattern**: Core services export a module-level instance (`export const sidecarManager = new SidecarManager()`) — don't create new instances
- **Only 2 commands**: `markdownThreads.publishDrafts` and `markdownThreads.openPreview` — registered in `package.json` and `extension.ts`
- **Explorer context menu** uses `resourceExtname == .md` (not `resourceLangId`) so it works on unopened files
- **Configuration keys** prefixed `markdownThreads.` (e.g., `autoOpenPR`, `branchPrefix`, `defaultProvider`)
- **Logging** uses `console.log('[MarkdownThreads] ...')` prefix
- **Delete by ID**: Use `sidecarManager.deleteCommentById()` (not index-based) for concurrency safety
- **Edit via sidecarManager**: Use `sidecarManager.editComment()` to update body + set `edited` timestamp — don't mutate entries directly
- **Reactions via sidecarManager**: Use `sidecarManager.toggleReaction()` — don't mutate `reactions` array directly
- Branch naming: `{branchPrefix}/{docSlug}-{user}-{date}-{randomHex}`
- UUIDs via `uuid` package (`v4`)

## Cross-Platform Compatibility (Windows, macOS, Linux)

This extension must work identically on all three platforms. Follow these rules in every change.

### File Paths

- **Always** use `path.join()`, `path.dirname()`, `path.basename()`, and `path.resolve()` for constructing file paths — never concatenate strings with `/` or `\\`
- **Never** hardcode path separators; use `path.sep` only when you genuinely need the platform separator as a string
- **Never** assume case-sensitive file systems — macOS (HFS+) and Windows (NTFS) are case-insensitive by default; Linux (ext4) is case-sensitive. `forceConsistentCasingInFileNames` is enabled in `tsconfig.json` — keep it that way
- In WebView HTML (`previewPanel.ts`), use VS Code `webview.asWebviewUri()` for all local resource URIs — never build `file://` URIs manually

### Line Endings (CRLF vs LF)

- **Normalize line endings** before processing markdown content. Always strip `\r` when splitting lines:
  ```typescript
  const lines = content.replace(/\r\n/g, '\n').split('\n');
  // or equivalently:
  const lines = content.split(/\r?\n/);
  ```
- Content hashing (in `utils/hash.ts`) must produce the **same hash** regardless of whether the input uses `\n` or `\r\n`. Normalize before hashing so that sidecar files remain valid across platforms.
- The repository should include a `.gitattributes` file with `* text=auto` (and `*.md text eol=lf`) to enforce consistent line endings in Git.

### Shell & Child Processes

- When shelling out (e.g., `execSync`), do not assume a specific shell (`/bin/sh`, `cmd.exe`). Prefer library APIs (like `simple-git`) over raw shell commands
- Assume `git` is on the `PATH` but wrap `execSync` calls in try/catch — on Windows the error message format may differ
- Never use Unix-only commands (`grep`, `sed`, `cat`, etc.) in production code

### Temp Files & OS APIs

- Use `os.tmpdir()` for temporary directories — never hardcode `/tmp` or `%TEMP%`
- Use `fs.mkdtempSync(path.join(os.tmpdir(), 'prefix-'))` for temp dirs in tests (already done correctly)
- Clean up temp resources in `teardown()` / `suiteTeardown()` using `fs.rmSync(..., { recursive: true, force: true })`

### Tests

- Test path inputs should use `path.join()` rather than hardcoded Unix paths like `'/repo/doc.md'` — this makes tests more realistic on Windows
- When asserting on file content, normalize line endings before comparison
- All tests must pass on Windows, macOS, and Linux — the CI matrix should cover all three

### Commits, Pushes and PRs
- **Never** Push changes to remove branch without running all unit tests and getting explicit approval from the user.
- **Always** create a unique message for each commit that describes the change being made. Avoid generic messages like "Update code" or "Fix bug".
- **Always** include a detailed description in the PR that explains the purpose of the changes, and the testing that was done to validate them.